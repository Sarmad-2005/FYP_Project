{% extends "base.html" %}

{% block title %}Financial Agent Dashboard - {{ project.name }}{% endblock %}

{% block content %}
<div class="financial-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title-modern">Financial Agent Dashboard</h1>
            <p class="dashboard-subtitle-modern">{{ project.name }} - AI-Powered Financial Analysis</p>
            <div class="dashboard-meta-info">
                <span>Project ID: {{ project.id }}</span>
                <span id="last-analysis-timestamp">Loading...</span>
            </div>
        </div>
        <div class="dashboard-controls">
            <button onclick="exportFinancialReport()" class="btn btn-success">
                <i class="fas fa-download"></i> Export Report
            </button>
            <button onclick="generateFinancialAnalysis(event)" class="btn btn-primary">
                <i class="fas fa-magic"></i> Generate Analysis
            </button>
            <button onclick="refreshFinancialData()" class="btn btn-secondary">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <a href="/project/{{ project.id }}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Back to Project
            </a>
        </div>
    </div>

    <!-- Metrics Overview -->
    <div class="financial-metrics-grid mt-8">
        <!-- Left Column: 4 Metric Cards -->
        <div class="metrics-column">
        <!-- Budget Card -->
        <div class="metric-card metric-card-blue">
            <div class="metric-card-header">
                <div class="metric-icon-wrapper metric-icon-blue">
                    <i class="fas fa-wallet"></i>
            </div>
                <span class="metric-badge metric-badge-blue" id="budget-badge">PKR 0</span>
                </div>
            <div class="metric-card-body">
                <h3 class="metric-card-title">Total Budget</h3>
                <div class="metric-value text-blue-600" id="budget-amount">PKR 0</div>
                <div class="metric-subtitle">Allocated Budget</div>
                <div class="metric-progress-container">
                    <div class="metric-progress-bar">
                        <div class="metric-progress-fill metric-progress-blue" id="budget-progress" style="width: 0%"></div>
                </div>
                    <p class="metric-progress-text" id="budget-utilization">0% utilized</p>
                </div>
            </div>
        </div>

        <!-- Expenses Card -->
        <div class="metric-card metric-card-amber">
            <div class="metric-card-header">
                <div class="metric-icon-wrapper metric-icon-amber">
                    <i class="fas fa-money-bill-wave"></i>
            </div>
                <span class="metric-badge metric-badge-amber" id="expenses-badge">PKR 0</span>
                </div>
            <div class="metric-card-body">
                <h3 class="metric-card-title">Total Expenses</h3>
                <div class="metric-value text-amber-600" id="expenses-amount">PKR 0</div>
                <div class="metric-subtitle">Total Spent</div>
                <div class="metric-info-row">
                    <i class="fas fa-receipt"></i>
                    <span><span id="expense-count">0</span> transactions</span>
                </div>
            </div>
        </div>

        <!-- Revenue Card -->
        <div class="metric-card metric-card-green">
            <div class="metric-card-header">
                <div class="metric-icon-wrapper metric-icon-green">
                    <i class="fas fa-coins"></i>
            </div>
                <span class="metric-badge metric-badge-green" id="revenue-badge">PKR 0</span>
                </div>
            <div class="metric-card-body">
                <h3 class="metric-card-title">Total Revenue</h3>
                <div class="metric-value text-green-600" id="revenue-amount">PKR 0</div>
                <div class="metric-subtitle">Total Received</div>
                <div class="metric-info-row">
                    <i class="fas fa-chart-line"></i>
                    <span><span id="revenue-count">0</span> transactions</span>
                </div>
            </div>
        </div>

        <!-- Health Card -->
        <div class="metric-card metric-card-purple">
            <div class="metric-card-header">
                <div class="metric-icon-wrapper metric-icon-purple">
                    <i class="fas fa-heartbeat"></i>
            </div>
                <span class="metric-badge" id="health-badge">Unknown</span>
                    </div>
            <div class="metric-card-body">
                <h3 class="metric-card-title">Financial Health</h3>
                <div class="health-circle-container">
                    <div class="health-circle">
                        <div class="health-percentage" id="health-percentage">0%</div>
                    </div>
                </div>
                <div class="metric-subtitle">Health Score</div>
            </div>
        </div>
        </div>
        
        <!-- Right Column: Financial Breakdown Visualization -->
        <div class="visualization-card">
            <div class="viz-card-header">
                <div class="viz-header-left">
                    <div class="viz-icon-wrapper">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div>
                        <h3 class="viz-title">Financial Breakdown</h3>
                        <p class="viz-subtitle">Expense distribution & revenue sources</p>
                    </div>
                </div>
                <div class="viz-tabs">
                    <button class="viz-tab active" data-chart="expenses" onclick="switchChart('expenses')">
                        <i class="fas fa-receipt"></i> Expenses
                    </button>
                    <button class="viz-tab" data-chart="revenue" onclick="switchChart('revenue')">
                        <i class="fas fa-coins"></i> Revenue
                    </button>
                </div>
            </div>
            <div class="viz-card-body">
                <div class="chart-container">
                    <canvas id="financialChart"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend"></div>
                
                <!-- Exchange Rate Display -->
                <div class="exchange-rate-display" id="exchangeRateDisplay">
                    <div class="exchange-rate-content">
                        <div class="exchange-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="exchange-info">
                            <div class="exchange-label">Live Exchange Rate</div>
                            <div class="exchange-value" id="viz-exchange-rate-main">
                                <span class="loading-dots">Loading...</span>
                            </div>
                        </div>
                        <div class="exchange-badge">
                            <i class="fas fa-sync-alt"></i> Real-time
                        </div>
                    </div>
                </div>
                
                <!-- Anomaly Alert Display -->
                <div class="anomaly-alert-display" id="anomalyAlertDisplay">
                    <div class="anomaly-alert-header">
                        <div class="anomaly-alert-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="anomaly-alert-info">
                            <div class="anomaly-alert-label">Anomaly Detection Status</div>
                            <div class="anomaly-alert-summary" id="viz-anomaly-summary">
                                <span class="loading-dots">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="anomaly-breakdown" id="viz-anomaly-breakdown">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- CSV Analysis CTA -->
                <div class="csv-analysis-cta">
                    <a href="/csv_analysis/{{ project_id }}" class="csv-cta-button">
                        <div class="csv-cta-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="csv-cta-content">
                            <div class="csv-cta-title">CSV Financial Analysis</div>
                            <div class="csv-cta-subtitle">Upload & analyze custom financial data with AI-powered insights</div>
                        </div>
                        <div class="csv-cta-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>
                </div>
            </div>
            <div class="viz-card-footer">
                <div class="viz-stat">
                    <i class="fas fa-layer-group text-blue-600"></i>
                    <div>
                        <div class="viz-stat-label">Categories</div>
                        <div class="viz-stat-value" id="viz-categories">0</div>
                    </div>
                </div>
                <div class="viz-stat">
                    <i class="fas fa-receipt text-amber-600"></i>
                    <div>
                        <div class="viz-stat-label">Transactions</div>
                        <div class="viz-stat-value" id="viz-transactions">0</div>
                    </div>
                </div>
                <div class="viz-stat">
                    <i class="fas fa-coins text-green-600"></i>
                    <div>
                        <div class="viz-stat-label">Total Amount</div>
                        <div class="viz-stat-value" id="viz-total">PKR 0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Section -->
    <div class="section mt-8">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-list-alt"></i> Financial Transactions
            </h2>
            <div class="section-controls">
                <select id="transaction-filter" class="filter-select">
                    <option value="all">All Transactions</option>
                    <option value="expense">Expenses Only</option>
                    <option value="revenue">Revenue Only</option>
                </select>
            </div>
        </div>
        <div id="transactions-list" class="grid grid-cols-1 gap-4 mt-4">
            <p class="text-gray-600">No transactions found. Generate financial analysis to extract transactions.</p>
        </div>
    </div>

    <!-- Anomaly Detection Section - Beautiful Expandable Card -->
    <div class="section mt-8">
        <div class="anomaly-mega-card">
            <!-- Card Header - Always Visible -->
            <div class="anomaly-header" onclick="toggleAnomalyCard()">
                <div class="anomaly-header-left">
                    <div class="anomaly-icon-wrapper">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <h2 class="anomaly-title">
                            AI Anomaly Detection
                            <span class="anomaly-badge" id="anomaly-total-badge">0</span>
            </h2>
                        <p class="anomaly-subtitle">Isolation Forest Algorithm ‚Ä¢ Real-time Fraud Detection</p>
        </div>
                </div>
                <div class="anomaly-header-right">
                    <div class="anomaly-summary-pills">
                        <div class="pill pill-critical" id="pill-critical" onclick="openAndSwitchView('critical')">
                            <span class="pill-count">0</span>
                            <span class="pill-label">Critical</span>
                    </div>
                        <div class="pill pill-high" id="pill-high" onclick="openAndSwitchView('high')">
                            <span class="pill-count">0</span>
                            <span class="pill-label">High</span>
                </div>
                        <div class="pill pill-medium" id="pill-medium" onclick="openAndSwitchView('medium')">
                            <span class="pill-count">0</span>
                            <span class="pill-label">Medium</span>
            </div>
                        <div class="pill pill-low" id="pill-low" onclick="openAndSwitchView('low')">
                            <span class="pill-count">0</span>
                            <span class="pill-label">Low</span>
                </div>
                    </div>
                    <button class="expand-btn" id="anomaly-expand-btn">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            
            <!-- Card Body - Expandable -->
            <div class="anomaly-body" id="anomaly-body" style="display: none;">
                <!-- Control Bar -->
                <div class="anomaly-controls">
                    <div class="control-tabs">
                        <button class="tab-btn active" data-view="all" onclick="switchAnomalyView('all')">
                            <i class="fas fa-th-list"></i> All Anomalies
                        </button>
                        <button class="tab-btn" data-view="critical" onclick="switchAnomalyView('critical')">
                            <i class="fas fa-exclamation-circle"></i> Critical
                        </button>
                        <button class="tab-btn" data-view="high" onclick="switchAnomalyView('high')">
                            <i class="fas fa-flag"></i> High Risk
                        </button>
                        <button class="tab-btn" data-view="medium" onclick="switchAnomalyView('medium')">
                            <i class="fas fa-exclamation-triangle"></i> Medium
                        </button>
                        <button class="tab-btn" data-view="low" onclick="switchAnomalyView('low')">
                            <i class="fas fa-info-circle"></i> Low
                        </button>
                        <button class="tab-btn" data-view="unreviewed" onclick="switchAnomalyView('unreviewed')">
                            <i class="fas fa-eye"></i> Unreviewed
                        </button>
                        <button class="tab-btn" data-view="reviewed_history" onclick="loadReviewedHistory()">
                            <i class="fas fa-history"></i> Reviewed History
                        </button>
                    </div>
                    <div class="control-actions">
                        <button class="action-btn" onclick="loadAnomalies(currentAnomalyView)">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="action-btn" onclick="exportAnomalies()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <!-- Anomalies Content -->
                <div class="anomaly-content" id="anomaly-content">
                    <div class="empty-state">
                        <i class="fas fa-shield-check"></i>
                        <h3>No Anomalies Detected</h3>
                        <p>All transactions appear normal. The system is monitoring continuously.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Analysis Section - Beautiful Expandable Card -->
    <div class="section mt-8">
        <div class="expense-mega-card">
            <!-- Card Header - Always Visible -->
            <div class="expense-header" onclick="toggleExpenseCard()">
                <div class="expense-header-left">
                    <div class="expense-icon-wrapper">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div>
                        <h2 class="expense-title">
                            Expense Analysis
                            <span class="expense-badge" id="expense-total-badge">PKR 0</span>
                        </h2>
                        <p class="expense-subtitle">Category Breakdown ‚Ä¢ Vendor Analysis ‚Ä¢ Task Mapping</p>
                    </div>
                </div>
                <div class="expense-header-right">
                    <div class="expense-summary-pills">
                        <div class="pill pill-expense" id="pill-categories" onclick="openAndSwitchExpenseView('categories')">
                            <span class="pill-count" id="categories-count">0</span>
                            <span class="pill-label">Categories</span>
                        </div>
                        <div class="pill pill-expense" id="pill-vendors" onclick="openAndSwitchExpenseView('vendors')">
                            <span class="pill-count" id="vendors-count">0</span>
                            <span class="pill-label">Vendors</span>
                        </div>
                        <div class="pill pill-expense" id="pill-tasks" onclick="openAndSwitchExpenseView('tasks')">
                            <span class="pill-count" id="tasks-count">0</span>
                            <span class="pill-label">Tasks</span>
                        </div>
                    </div>
                    <button class="expand-btn" id="expense-expand-btn">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            
            <!-- Card Body - Expandable -->
            <div class="expense-body" id="expense-body" style="display: none;">
                <!-- Control Bar -->
                <div class="expense-controls">
                    <div class="control-tabs">
                        <button class="tab-btn active" data-view="categories" onclick="switchExpenseView('categories')">
                            <i class="fas fa-layer-group"></i> By Category
                        </button>
                        <button class="tab-btn" data-view="vendors" onclick="switchExpenseView('vendors')">
                            <i class="fas fa-users"></i> Top Vendors
                        </button>
                        <button class="tab-btn" data-view="tasks" onclick="switchExpenseView('tasks')">
                            <i class="fas fa-tasks"></i> Task Mapping
                        </button>
                        <button class="tab-btn" data-view="breakdown" onclick="switchExpenseView('breakdown')">
                            <i class="fas fa-chart-bar"></i> Detailed Breakdown
                        </button>
                    </div>
                    <div class="control-actions">
                        <button class="action-btn" onclick="loadExpenseData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="action-btn" onclick="exportExpenseData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <!-- Expense Content -->
                <div class="expense-content" id="expense-content">
                    <div class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <h3>No Expense Data</h3>
                        <p>Run financial analysis to see expense breakdown.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Details Section -->
    <div class="section mt-8">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-file-invoice-dollar"></i> Financial Details
            </h2>
        </div>
        <div id="financial-details-list" class="grid grid-cols-1 gap-4 mt-4">
            <p class="text-gray-600">No financial details extracted yet.</p>
        </div>
    </div>

    <!-- Actor to Transactions Mapping (Horizontal Card) -->
    <div class="section mt-8">
        <div class="actor-map-card" id="actor-map-card">
            <div class="actor-map-header">
                <div class="actor-map-title">
                    <div class="actor-map-icon"><i class="fas fa-link"></i></div>
                    <div>
                        <h3>Actor ‚Üí Transaction Mapper</h3>
                        <p>Links project actors to their related financial transactions</p>
                    </div>
                </div>
                <div class="actor-map-actions">
                    <button class="btn btn-secondary" onclick="loadActorTransactionMappings()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-primary" onclick="triggerActorTransactionMapping()">
                        <i class="fas fa-magic"></i> Map Now
                    </button>
                </div>
            </div>
            <div id="actor-map-body" class="actor-map-body">
                <div class="empty-state">
                    <i class="fas fa-user-friends"></i>
                    <h3>No mappings yet</h3>
                    <p>Click "Map Now" to link actors with their related transactions.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.actor-map-card {
    background: linear-gradient(135deg, #f8fafc, #eef2ff);
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.12);
}
.actor-map-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}
.actor-map-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}
.actor-map-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 6px 14px rgba(99, 102, 241, 0.25);
}
.actor-map-title h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    color: #1f2937;
}
.actor-map-title p {
    margin: 0;
    color: #4b5563;
    font-size: 0.95rem;
}
.actor-map-actions {
    display: flex;
    gap: 0.75rem;
}
.actor-map-body {
    margin-top: 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
}
.actor-map-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
}
.actor-map-item {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    background: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}
.actor-map-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}
.actor-map-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
}
.actor-map-item h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.actor-map-item h4::before {
    content: 'üë§';
    font-size: 1.2rem;
}
.actor-map-meta {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
    line-height: 1.5;
}
.actor-map-transactions {
    font-size: 0.9rem;
    color: #111827;
    margin: 0.5rem 0 0 0;
    line-height: 1.6;
}
.actor-map-transaction-item {
    background: #f3f4f6;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    margin: 0.5rem 0;
    border-left: 3px solid #3b82f6;
}
.actor-map-confidence-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.actor-map-confidence-badge.high {
    background: #d1fae5;
    color: #065f46;
}
.actor-map-confidence-badge.medium {
    background: #fef3c7;
    color: #92400e;
}
.actor-map-confidence-badge.low {
    background: #fee2e2;
    color: #991b1b;
}
.actor-map-transaction-item strong {
    color: #1f2937;
    font-weight: 600;
}
.actor-map-badge {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.75rem;
}
.actor-map-summary {
    background: #f0f9ff;
    border-left: 3px solid #0ea5e9;
    padding: 0.75rem;
    border-radius: 6px;
    margin: 0.75rem 0;
    font-size: 0.875rem;
    color: #0c4a6e;
    font-style: italic;
}
.actor-map-count {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #dbeafe;
    color: #1e40af;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
}
.actor-map-count::before {
    content: 'üí∞';
    font-size: 1rem;
}
</style>

<script>
const projectId = "{{ project.id }}";
let actorMappingInProgress = false;

// Load financial dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFinancialDashboard();
    loadActorTransactionMappings();
    
    // Set up transaction filter
    document.getElementById('transaction-filter').addEventListener('change', function() {
        filterTransactions(this.value);
    });
    
    
    // Load anomalies on startup
    setTimeout(() => loadAnomalies('all'), 1000);
});

async function loadFinancialDashboard() {
    try {
        console.log('Loading financial dashboard...');
        
        const response = await fetch(`/financial_agent/quick_status/${projectId}`);
        const data = await response.json();
        
        if (data.success) {
            updateDashboard(data);
            // Load chart data
            await loadChartData();
        } else {
            console.error('Error loading financial data:', data.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Actor ‚Üí Transaction Mapping
async function loadActorTransactionMappings() {
    const body = document.getElementById('actor-map-body');
    if (!body) return;
    body.innerHTML = `<div class="loading-state"><span class="loading-dots">Loading mappings...</span></div>`;
    try {
        console.log('üîó [Actor-Transaction] Fetching mappings for project:', projectId);
        const response = await fetch(`/financial_agent/actor_transaction_mappings/${projectId}`);
        const data = await response.json();
        console.log('üîó [Actor-Transaction] Received data:', data);
        
        if (data.success && data.mappings && data.mappings.length) {
            console.log(`üîó [Actor-Transaction] Rendering ${data.mappings.length} mappings`);
            renderActorMap(data.mappings);
        } else {
            console.log('üîó [Actor-Transaction] No mappings found');
            body.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-friends"></i>
                    <h3>No mappings yet</h3>
                    <p>Click "Map Now" to link actors with their related transactions.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå [Actor-Transaction] Error loading actor mappings:', error);
        body.innerHTML = `<div class="empty-state"><p style="color:#ef4444;">Failed to load mappings: ${error.message}</p></div>`;
    }
}

async function triggerActorTransactionMapping() {
    if (actorMappingInProgress) return;
    actorMappingInProgress = true;
    const body = document.getElementById('actor-map-body');
    if (body) {
        body.innerHTML = `<div class="loading-state"><span class="loading-dots">Mapping actors to transactions...</span></div>`;
    }
    try {
        const response = await fetch('/financial_agent/map_actor_transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project_id: projectId })
        });
        const data = await response.json();
        if (data.success) {
            loadActorTransactionMappings();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (error) {
        console.error('Error mapping actors:', error);
        if (body) {
            body.innerHTML = `<div class="empty-state"><p style="color:#ef4444;">Mapping failed: ${error.message}</p></div>`;
        }
    } finally {
        actorMappingInProgress = false;
    }
}

function renderActorMap(mappings) {
    const body = document.getElementById('actor-map-body');
    if (!body) return;
    
    console.log('üîó [Actor-Transaction] Rendering mappings:', mappings);
    
    // Filter to only show actors with transactions (txs.length > 0)
    const filteredMappings = mappings.filter(m => {
        const meta = m.metadata || m;
        const txs = meta.transactions || [];
        return txs.length > 0;
    });
    
    if (filteredMappings.length === 0) {
        body.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-user-friends"></i>
                <h3>No mapped transactions yet</h3>
                <p>Click "Map Now" to link actors with their related transactions.</p>
            </div>
        `;
        return;
    }
    
    const cards = filteredMappings.map(m => {
        // Data structure: {id, text, metadata: {actor_id, actor_name, actor_type, transactions, summary}}
        const meta = m.metadata || m;
        const txs = meta.transactions || [];
        
        const txItems = txs.map(t => {
            const txId = t.transaction_id || t.id || '';
            const confidence = Math.round((t.confidence || 0) * 100);
            const reason = escapeHtml(t.reason || '');
            const confidenceColor = confidence >= 70 ? '#10b981' : confidence >= 50 ? '#f59e0b' : '#ef4444';
            
            // Get transaction details if available
            const txDetails = t.transaction_details || {};
            const amount = txDetails.amount || 0;
            const currency = txDetails.currency || 'PKR';
            const txType = txDetails.type || '';
            const category = txDetails.category || '';
            const vendor = txDetails.vendor_recipient || '';
            const description = escapeHtml(txDetails.description || '');
            const date = txDetails.date || '';
            
            // Format amount
            const amountFormatted = amount > 0 ? `PKR ${formatNumber(amount)}` : '';
            
            // Build transaction display
            let txInfo = '';
            if (description) {
                txInfo += `<div style="margin-top: 0.5rem; color: #1f2937; font-weight: 500;">${description}</div>`;
            }
            if (amountFormatted) {
                txInfo += `<div style="margin-top: 0.25rem; color: #059669; font-weight: 600;">${amountFormatted}</div>`;
            }
            if (category || vendor) {
                const details = [category, vendor].filter(Boolean).join(' ‚Ä¢ ');
                if (details) {
                    txInfo += `<div style="margin-top: 0.25rem; color: #6b7280; font-size: 0.8rem;">${escapeHtml(details)}</div>`;
                }
            }
            if (date) {
                txInfo += `<div style="margin-top: 0.25rem; color: #9ca3af; font-size: 0.75rem;">üìÖ ${escapeHtml(date)}</div>`;
            }
            
            // Determine badge class based on confidence
            let badgeClass = 'low';
            if (confidence >= 70) badgeClass = 'high';
            else if (confidence >= 50) badgeClass = 'medium';
            
            return `
                <div class="actor-map-transaction-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="color: #1f2937;">${txId}</strong>
                        <span class="actor-map-confidence-badge ${badgeClass}">${confidence}% Match</span>
                    </div>
                    ${reason ? `<div style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem; font-style: italic;">${reason}</div>` : ''}
                    ${txInfo}
                </div>
            `;
        }).join('');
        
        const actorName = escapeHtml(meta.actor_name || 'Unknown Actor');
        const actorType = escapeHtml(meta.actor_type || 'Actor');
        const summary = escapeHtml(meta.summary || '');
        
        return `
            <div class="actor-map-item">
                <span class="actor-map-badge">${actorType}</span>
                <h4>${actorName}</h4>
                ${summary ? `<div class="actor-map-summary">${summary}</div>` : ''}
                <div class="actor-map-count">${txs.length} transaction${txs.length !== 1 ? 's' : ''} linked</div>
                <div class="actor-map-transactions">
                    ${txItems}
                </div>
            </div>
        `;
    }).join('');
    body.innerHTML = `<div class="actor-map-list">${cards}</div>`;
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

function updateDashboard(data) {
    // Update budget
    document.getElementById('budget-amount').textContent = `PKR ${formatNumber(data.budget || 0)}`;
    document.getElementById('budget-badge').textContent = `PKR ${formatNumber(data.budget || 0)}`;
    
    // Update expenses
    document.getElementById('expenses-amount').textContent = `PKR ${formatNumber(data.total_expenses || 0)}`;
    document.getElementById('expenses-badge').textContent = `PKR ${formatNumber(data.total_expenses || 0)}`;
    document.getElementById('expense-count').textContent = data.expense_count || 0;
    
    // Update revenue
    document.getElementById('revenue-amount').textContent = `PKR ${formatNumber(data.total_revenue || 0)}`;
    document.getElementById('revenue-badge').textContent = `PKR ${formatNumber(data.total_revenue || 0)}`;
    document.getElementById('revenue-count').textContent = data.revenue_count || 0;
    
    // Update financial health
    const healthScore = data.financial_health || 0;
    document.getElementById('health-percentage').textContent = `${healthScore.toFixed(1)}%`;
    
    const healthBadge = document.getElementById('health-badge');
    if (healthScore >= 80) {
        healthBadge.textContent = 'Healthy';
        healthBadge.className = 'badge badge-success';
    } else if (healthScore >= 60) {
        healthBadge.textContent = 'Warning';
        healthBadge.className = 'badge badge-warning';
    } else {
        healthBadge.textContent = 'Critical';
        healthBadge.className = 'badge badge-danger';
    }
    
    // Update budget utilization
    if (data.budget && data.budget > 0) {
        const utilization = (data.total_expenses / data.budget) * 100;
        document.getElementById('budget-progress').style.width = `${Math.min(utilization, 100)}%`;
        document.getElementById('budget-utilization').textContent = `${utilization.toFixed(1)}% utilized`;
    }
    
    // Update transactions
    if (data.transactions && data.transactions.length > 0) {
        displayTransactions(data.transactions);
    }
    
    // Update expense analysis
    if (data.expense_analysis) {
        displayExpenseAnalysis(data.expense_analysis);
    }
    
    // Update financial details
    if (data.financial_details && data.financial_details.length > 0) {
        displayFinancialDetails(data.financial_details);
    } else {
        // Show message if no financial details
        const container = document.getElementById('financial-details-list');
        container.innerHTML = '<p class="text-gray-600">No financial details extracted yet. Click "Refresh" to extract budget and cost information from documents.</p>';
    }
    
    // Update last analysis timestamp
    const timestamp = new Date().toLocaleString('en-PK', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('last-analysis-timestamp').innerHTML = 
        `<i class="fas fa-clock text-blue-500"></i> Last updated: ${timestamp}`;
}

function displayTransactions(transactions) {
    const container = document.getElementById('transactions-list');
    container.innerHTML = '';
    
    transactions.forEach(txn => {
        const metadata = txn.metadata || {};
        const type = metadata.transaction_type || 'unknown';
        const amount = metadata.amount || 0;
        const date = metadata.date || 'Not specified';
        const timePeriod = metadata.time_period || date;
        const vendor = metadata.vendor_recipient || 'Unknown';
        
        // Format the time period for better display
        const displayTime = formatTimePeriod(timePeriod);
        
        const txnCard = document.createElement('div');
        txnCard.className = 'card transaction-card';
        txnCard.dataset.type = type;
        txnCard.innerHTML = `
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center gap-4">
                    <div class="transaction-icon ${type}">
                        <i class="fas fa-${type === 'expense' ? 'arrow-down' : 'arrow-up'}"></i>
                    </div>
                    <div>
                        <p class="font-semibold">${vendor}</p>
                        <p class="text-sm text-gray-600">${txn.text || metadata.category || 'No description'}</p>
                        <p class="text-xs text-gray-500">
                            <i class="fas fa-clock"></i> ${displayTime}
                        </p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold ${type === 'expense' ? 'text-red-600' : 'text-green-600'}">
                        ${type === 'expense' ? '-' : '+'}PKR ${formatNumber(amount)}
                    </p>
                    <span class="badge badge-sm badge-${type === 'expense' ? 'warning' : 'success'}">
                        ${type}
                    </span>
                </div>
            </div>
        `;
        container.appendChild(txnCard);
    });
}

// ==================== EXPENSE ANALYSIS FUNCTIONS ====================

let currentExpenseView = 'categories';
let expenseData = null;

function toggleExpenseCard() {
    const body = document.getElementById('expense-body');
    const btn = document.getElementById('expense-expand-btn');
    const icon = btn.querySelector('i');
    
    if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        body.style.animation = 'slideDown 0.3s ease-out';
    } else {
        body.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

function openAndSwitchExpenseView(view) {
    const body = document.getElementById('expense-body');
    if (body.style.display === 'none') {
        toggleExpenseCard();
    }
    setTimeout(() => switchExpenseView(view), 100);
    event.stopPropagation();
}

function switchExpenseView(view) {
    currentExpenseView = view;
    
    document.querySelectorAll('.expense-controls .tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        }
    });
    
    if (expenseData) {
        displayExpenseView(view, expenseData);
    }
}

function loadExpenseData() {
    fetch(`/financial_agent/quick_status/${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.expense_analysis) {
                displayExpenseAnalysis(data.expense_analysis);
            }
        })
        .catch(error => console.error('Error loading expense data:', error));
}

function displayExpenseAnalysis(analysis) {
    expenseData = analysis;
    const byCategory = analysis.by_category || {};
    const byVendor = analysis.by_vendor || {};
    const byTask = analysis.by_task || {};
    const totalExpenses = analysis.total_expenses || 0;
    
    // Update header pills
    document.getElementById('expense-total-badge').textContent = `PKR ${formatNumber(totalExpenses)}`;
    document.getElementById('categories-count').textContent = Object.keys(byCategory).length;
    document.getElementById('vendors-count').textContent = Object.keys(byVendor).length;
    document.getElementById('tasks-count').textContent = Object.keys(byTask).length;
    
    // Display current view
    displayExpenseView(currentExpenseView, analysis);
}

function displayExpenseView(view, analysis) {
    const container = document.getElementById('expense-content');
    
    if (view === 'categories') {
        displayCategoriesView(container, analysis.by_category || {});
    } else if (view === 'vendors') {
        displayVendorsView(container, analysis.by_vendor || {});
    } else if (view === 'tasks') {
        displayTasksView(container, analysis.by_task || {});
    } else if (view === 'breakdown') {
        displayBreakdownView(container, analysis);
    }
}

function displayCategoriesView(container, byCategory) {
    if (Object.keys(byCategory).length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-layer-group"></i>
                <h3>No Category Data</h3>
                <p>No expenses have been categorized yet.</p>
            </div>
        `;
        return;
    }
    
    const sortedCategories = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
    const total = sortedCategories.reduce((sum, [_, amount]) => sum + amount, 0);
    
    let html = '<div class="expense-grid">';
    
    sortedCategories.forEach(([category, amount], index) => {
        const percentage = total > 0 ? (amount / total * 100).toFixed(1) : 0;
        const categoryColors = [
            { bg: 'from-blue-50 to-blue-100', border: 'border-blue-500', text: 'text-blue-700', bar: 'bg-blue-500' },
            { bg: 'from-green-50 to-green-100', border: 'border-green-500', text: 'text-green-700', bar: 'bg-green-500' },
            { bg: 'from-purple-50 to-purple-100', border: 'border-purple-500', text: 'text-purple-700', bar: 'bg-purple-500' },
            { bg: 'from-orange-50 to-orange-100', border: 'border-orange-500', text: 'text-orange-700', bar: 'bg-orange-500' },
            { bg: 'from-pink-50 to-pink-100', border: 'border-pink-500', text: 'text-pink-700', bar: 'bg-pink-500' }
        ];
        const colors = categoryColors[index % categoryColors.length];
        
        html += `
            <div class="expense-card bg-gradient-to-br ${colors.bg} border-l-4 ${colors.border}">
                <div class="expense-card-header">
                    <div class="expense-card-title ${colors.text}">
                        <i class="fas fa-tag"></i>
                        <span>${category}</span>
                    </div>
                    <div class="expense-percentage">${percentage}%</div>
                </div>
                <div class="expense-card-body">
                    <div class="expense-amount-display">
                        <span class="amount-label">Total Spent</span>
                        <span class="amount-value ${colors.text}">PKR ${formatNumber(amount)}</span>
                    </div>
                    <div class="expense-progress-bar">
                        <div class="expense-progress-fill ${colors.bar}" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayVendorsView(container, byVendor) {
    if (Object.keys(byVendor).length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>No Vendor Data</h3>
                <p>No vendor information available.</p>
            </div>
        `;
        return;
    }
    
    const sortedVendors = Object.entries(byVendor).sort((a, b) => b[1] - a[1]);
    const total = sortedVendors.reduce((sum, [_, amount]) => sum + amount, 0);
    
    let html = '<div class="expense-list">';
    
    sortedVendors.forEach(([vendor, amount], index) => {
        const percentage = total > 0 ? (amount / total * 100).toFixed(1) : 0;
        const rank = index + 1;
        const rankBadgeColor = rank === 1 ? 'bg-yellow-500' : rank === 2 ? 'bg-gray-400' : rank === 3 ? 'bg-orange-600' : 'bg-gray-300';
        
        html += `
            <div class="vendor-item">
                <div class="vendor-rank ${rankBadgeColor}">
                    ${rank <= 3 ? '<i class="fas fa-crown"></i>' : rank}
                </div>
                <div class="vendor-info">
                    <div class="vendor-name">${vendor}</div>
                    <div class="vendor-progress-bar">
                        <div class="vendor-progress-fill" style="width: ${percentage}%"></div>
                    </div>
                </div>
                <div class="vendor-stats">
                    <div class="vendor-amount">PKR ${formatNumber(amount)}</div>
                    <div class="vendor-percentage">${percentage}%</div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayTasksView(container, byTask) {
    if (!byTask || Object.keys(byTask).length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tasks"></i>
                <h3>No Task Mapping Data</h3>
                <p>Expenses haven't been mapped to tasks yet.</p>
            </div>
        `;
        return;
    }
    
    const taskEntries = Object.entries(byTask).sort((a, b) => b[1] - a[1]);
    
    let html = '<div class="task-expense-grid">';
    
    taskEntries.forEach(([taskName, amount]) => {
        html += `
            <div class="task-expense-card">
                <div class="task-expense-header">
                    <i class="fas fa-clipboard-check text-indigo-600"></i>
                    <span class="task-name">${taskName}</span>
                </div>
                <div class="task-expense-amount">PKR ${formatNumber(amount)}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayBreakdownView(container, analysis) {
    const html = `
        <div class="breakdown-view">
            <div class="breakdown-summary">
                <div class="breakdown-card">
                    <i class="fas fa-money-bill-wave text-green-600"></i>
                    <div>
                        <div class="breakdown-label">Total Expenses</div>
                        <div class="breakdown-value">PKR ${formatNumber(analysis.total_expenses || 0)}</div>
                    </div>
                </div>
                <div class="breakdown-card">
                    <i class="fas fa-layer-group text-blue-600"></i>
                    <div>
                        <div class="breakdown-label">Categories</div>
                        <div class="breakdown-value">${Object.keys(analysis.by_category || {}).length}</div>
                    </div>
                </div>
                <div class="breakdown-card">
                    <i class="fas fa-users text-purple-600"></i>
                    <div>
                        <div class="breakdown-label">Vendors</div>
                        <div class="breakdown-value">${Object.keys(analysis.by_vendor || {}).length}</div>
                    </div>
                </div>
                <div class="breakdown-card">
                    <i class="fas fa-clipboard-list text-orange-600"></i>
                    <div>
                        <div class="breakdown-label">Tasks</div>
                        <div class="breakdown-value">${Object.keys(analysis.by_task || {}).length}</div>
                    </div>
                </div>
            </div>
            
            <div class="breakdown-details">
                <h3 class="breakdown-title">Complete Expense Overview</h3>
                <div class="breakdown-section">
                    <h4><i class="fas fa-layer-group"></i> By Category</h4>
                    ${generateBreakdownList(analysis.by_category || {})}
                </div>
                <div class="breakdown-section">
                    <h4><i class="fas fa-users"></i> By Vendor</h4>
                    ${generateBreakdownList(analysis.by_vendor || {})}
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function generateBreakdownList(data) {
    if (Object.keys(data).length === 0) return '<p class="text-gray-500 text-sm">No data available</p>';
    
    const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);
    let html = '<ul class="breakdown-list">';
    sorted.forEach(([name, amount]) => {
        html += `
            <li>
                <span>${name}</span>
            <span class="font-semibold">PKR ${formatNumber(amount)}</span>
            </li>
        `;
    });
    html += '</ul>';
    return html;
}

function exportExpenseData() {
    if (!expenseData) {
        showNotification('No expense data to export', 'error');
        return;
    }
    
    const exportObj = {
        ...expenseData,
        exported_at: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `expense_analysis_${projectId}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Expense data exported successfully', 'success');
}

function displayFinancialDetails(details) {
    const container = document.getElementById('financial-details-list');
    
    console.log('Financial details received:', details);
    
    if (!details || details.length === 0) {
        container.innerHTML = '<p class="text-gray-600">No financial details extracted yet. Run the Refresh to extract budget and cost information from documents.</p>';
        return;
    }
    
    container.innerHTML = '';
    
    // Group and deduplicate by amount to avoid showing same amount multiple times
    const uniqueDetails = [];
    const seenAmounts = new Set();
    
    details.forEach(detail => {
        const metadata = detail.metadata || {};
        const amount = metadata.amount || 0;
        
        // Skip if we've already seen this exact amount (deduplication)
        if (amount > 0 && seenAmounts.has(amount)) {
            return;
        }
        seenAmounts.add(amount);
        uniqueDetails.push(detail);
    });
    
    uniqueDetails.forEach(detail => {
        const metadata = detail.metadata || {};
        let type = metadata.detail_type || metadata.type || 'unknown';
        const amount = metadata.amount || 0;
        const category = metadata.category || '';
        
        // Better type labels
        const typeLabels = {
            'budget_allocation': 'BUDGET',
            'cost_estimate': 'COST ESTIMATE',
            'payment_schedule': 'PAYMENT',
            'financial_constraint': 'CONSTRAINT',
            'financial_milestone': 'MILESTONE',
            'extracted_amount': 'AMOUNT', // Legacy type
            'unknown': 'FINANCIAL DETAIL'
        };
        
        const displayType = typeLabels[type] || type.replace(/_/g, ' ').toUpperCase();
        
        // Better badge colors based on type
        let badgeClass = 'badge-info';
        if (type === 'budget_allocation') badgeClass = 'badge-success';
        else if (type === 'cost_estimate') badgeClass = 'badge-warning';
        else if (type === 'payment_schedule') badgeClass = 'badge-primary';
        
        const detailCard = document.createElement('div');
        detailCard.className = 'card p-4 mb-3';
        detailCard.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="badge ${badgeClass} badge-sm">${displayType}</span>
                        ${category && category !== 'general' ? `<span class="text-xs text-gray-500">Category: ${category}</span>` : ''}
                    </div>
                    <p class="text-sm text-gray-700">${detail.text || 'No description'}</p>
                </div>
                ${amount > 0 ? `<div class="text-right ml-4">
                    <p class="font-bold text-blue-600 text-lg">PKR ${formatNumber(amount)}</p>
                    <p class="text-xs text-gray-500">${metadata.currency || 'PKR'}</p>
                </div>` : ''}
            </div>
        `;
        container.appendChild(detailCard);
    });
}

function filterTransactions(type) {
    const transactions = document.querySelectorAll('.transaction-card');
    transactions.forEach(txn => {
        if (type === 'all' || txn.dataset.type === type) {
            txn.style.display = 'block';
        } else {
            txn.style.display = 'none';
        }
    });
}

// Generate Financial Analysis (First-Time Generation for All Documents)
async function generateFinancialAnalysis(event) {
    try {
        const btn = event?.target?.closest('button') || document.querySelector('button[onclick*="generateFinancialAnalysis"]');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        }
        
        showNotification('üîÑ Starting full financial analysis for all documents... This may take 2-3 minutes.', 'info');
        
        const response = await fetch('/financial_agent/first_generation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId
                // No document_id = process all documents
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Financial Analysis Results:', data);
        
        if (data.success !== false) {
            // Reload dashboard data
            await loadFinancialDashboard();
            showNotification(
                `‚úÖ Analysis complete! Processed ${data.documents_processed || 1} document(s). Found ${data.transactions?.count || 0} transactions.`,
                'success'
            );
        } else {
            throw new Error(data.error || 'Analysis failed');
        }
        
    } catch (error) {
        console.error('‚ùå ERROR during financial analysis:', error);
        showNotification('‚ùå Error: ' + error.message, 'error');
    } finally {
        const btn = event?.target?.closest('button') || document.querySelector('button[onclick*="generateFinancialAnalysis"]');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate Analysis';
        }
    }
}

async function refreshFinancialData() {
    try {
        const btn = event.target.closest('button');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Start background processing
        const response = await fetch(`/financial_agent/status/${projectId}`);
        const data = await response.json();
        
        if (data.processing) {
            // Job started, now poll for status
            showNotification('Financial data processing started...', 'info');
            pollProcessingStatus(btn, data.job_id);
        } else if (data.success) {
            // Already completed (cached result)
            updateDashboard(data);
            showNotification('Financial data loaded!', 'success');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
        } else {
            showNotification('Error starting processing: ' + data.error, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error refreshing data', 'error');
        const btn = event.target.closest('button');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
    }
}

function pollProcessingStatus(btn, jobId) {
    let pollCount = 0;
    const maxPolls = 200; // Max 10 minutes (200 * 3 seconds)
    
    const pollInterval = setInterval(async () => {
        pollCount++;
        
        try {
            const response = await fetch(`/financial_agent/processing_status/${projectId}`);
            
            // Check if response is OK
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const status = await response.json();
            console.log('Poll status:', status); // Debug log
            
            if (status.found && status.status === 'completed') {
                clearInterval(pollInterval);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
                
                // Reload dashboard data
                await loadFinancialDashboard();
                
                // Reload anomalies after processing completes
                await loadAnomalies('all');
                
                showNotification('Financial data updated successfully!', 'success');
                
            } else if (status.found && status.status === 'failed') {
                clearInterval(pollInterval);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
                showNotification('Processing failed: ' + (status.error || 'Unknown error'), 'error');
                
            } else if (pollCount >= maxPolls) {
                // Timeout after max polls
                clearInterval(pollInterval);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
                showNotification('Processing timeout - taking longer than expected', 'warning');
            } else {
                // Still processing, update button text
                const elapsed = Math.floor(pollCount * 3);
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing... ${elapsed}s`;
            }
            
        } catch (error) {
            console.error('Error polling status:', error);
            clearInterval(pollInterval);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
            
            // More specific error message
            const errorMsg = error.message || 'Unknown error';
            showNotification(`Error checking status: ${errorMsg}. Try refreshing the page.`, 'error');
        }
        
    }, 3000); // Poll every 3 seconds
}

function exportFinancialReport() {
    window.location.href = `/financial_agent/export/${projectId}`;
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-PK').format(num);
}

function formatTimePeriod(timePeriod) {
    if (!timePeriod || timePeriod === 'unknown' || timePeriod === 'not specified') {
        return 'Date not specified';
    }
    
    // Check if it's a date in YYYY-MM-DD format
    if (/^\d{4}-\d{2}-\d{2}$/.test(timePeriod)) {
        const date = new Date(timePeriod);
        return date.toLocaleDateString('en-PK', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }
    
    // Capitalize first letter of relative time descriptions
    return timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1);
}

function showNotification(message, type) {
    // Create a toast notification instead of alert
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 9999;
        font-weight: 500;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ==================== ANOMALY DETECTION FUNCTIONS ====================

let currentAnomalyView = 'all';
let allAnomaliesData = [];
let totalSeverityCounts = { critical: 0, high: 0, medium: 0, low: 0 }; // Store original counts

function toggleAnomalyCard() {
    const body = document.getElementById('anomaly-body');
    const btn = document.getElementById('anomaly-expand-btn');
    const icon = btn.querySelector('i');
    
    if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        body.style.animation = 'slideDown 0.3s ease-out';
    } else {
        body.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

function openAndSwitchView(view) {
    // Open the card if it's closed
    const body = document.getElementById('anomaly-body');
    if (body.style.display === 'none') {
        toggleAnomalyCard();
    }
    
    // Switch to the view after a small delay to allow animation
    setTimeout(() => switchAnomalyView(view), 100);
    
    // Prevent the header click from toggling
    event.stopPropagation();
}

function switchAnomalyView(view) {
    currentAnomalyView = view;
    
    // Update active tab
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        }
    });
    
    // Load anomalies with filter
    if (view === 'unreviewed') {
        loadAnomalies('all', 'unreviewed');
    } else if (view === 'reviewed_history') {
        // Don't load here, handled by loadReviewedHistory()
        return;
    } else {
        loadAnomalies(view);
    }
}

function loadReviewedHistory() {
    currentAnomalyView = 'reviewed_history';
    
    // Update active tab
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === 'reviewed_history') {
            btn.classList.add('active');
        }
    });
    
    // Load reviewed anomalies
    fetch(`/financial_agent/anomalies/reviewed/${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReviewedHistory(data.reviewed_anomalies);
            } else {
                console.error('Error loading reviewed anomalies:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function displayReviewedHistory(reviewedAnomalies) {
    const container = document.getElementById('anomaly-content');
    
    if (!reviewedAnomalies || reviewedAnomalies.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-clipboard-check"></i>
                <h3>No Reviewed Anomalies Yet</h3>
                <p>Reviewed and dismissed anomalies will appear here.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="anomaly-grid">';
    reviewedAnomalies.forEach(anomaly => {
        const metadata = anomaly.metadata || {};
        const severityLevel = metadata.severity_level || 'low';
        const severity = metadata.severity || 0;
        const amount = metadata.amount || 0;
        const category = metadata.category || 'general';
        const vendor = metadata.vendor_recipient || 'Unknown';
        const date = metadata.date || 'Unknown';
        const status = metadata.status || 'reviewed';
        const reviewedAt = metadata.reviewed_at || metadata.review_timestamp || 'Unknown';
        const notes = metadata.review_notes || 'No notes';
        
        const statusIcon = status === 'reviewed' ? 'fa-check-circle' : 'fa-times-circle';
        const statusClass = status === 'reviewed' ? 'status-reviewed' : 'status-dismissed';
        const statusColor = status === 'reviewed' ? '#10b981' : '#9ca3af';
        
        html += `
            <div class="anomaly-card severity-${severityLevel} ${statusClass}">
                <div class="anomaly-card-header">
                    <div class="anomaly-card-title">
                        <span class="severity-badge badge-${severityLevel}">${severityLevel.toUpperCase()}</span>
                        <span class="anomaly-score">Score: ${severity}/100</span>
                    </div>
                    <div class="anomaly-status" style="color: ${statusColor}">
                        <i class="fas ${statusIcon}"></i>
                        <span>${status === 'reviewed' ? 'Reviewed' : 'Dismissed'}</span>
                    </div>
                </div>
                
                <div class="anomaly-card-body">
                    <div class="anomaly-amount">
                        <i class="fas fa-dollar-sign"></i>
                        <span class="amount-value">PKR ${formatNumber(amount)}</span>
                    </div>
                    
                    <div class="anomaly-details-grid">
                        <div class="detail-item">
                            <i class="fas fa-tag"></i>
                            <div>
                                <div class="detail-label">Category</div>
                                <div class="detail-value">${category}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user-tie"></i>
                            <div>
                                <div class="detail-label">Vendor</div>
                                <div class="detail-value">${vendor}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <div>
                                <div class="detail-label">Date</div>
                                <div class="detail-value">${date}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="review-info" style="background: #f0fdf4; border-left: 3px solid #10b981; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-clock" style="color: #10b981;"></i>
                            <strong>Reviewed:</strong> ${new Date(reviewedAt).toLocaleString()}
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                            <i class="fas fa-comment" style="color: #10b981; margin-top: 0.25rem;"></i>
                            <div>
                                <strong>Notes:</strong> ${notes}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function loadAnomalies(severityFilter = 'all', statusFilter = null) {
    try {
        console.log(`Loading anomalies with severity: ${severityFilter}, status: ${statusFilter}`);
        
        // Always load ALL anomalies first to get accurate total counts
        const allUrl = `/financial_agent/anomalies/${projectId}`;
        const allResponse = await fetch(allUrl);
        const allData = await allResponse.json();
        
        if (allData.success) {
            // Store total counts (these never change)
            totalSeverityCounts = allData.severity_counts;
            
            // Update pills with total counts
            updateAnomalySummary(totalSeverityCounts, allData.total_count);
            
            // Also update the visualization card anomaly summary
            updateVizAnomalySummary(allData.total_count, allData.severity_counts);
        }
        
        // Now load filtered data if needed
        let url = `/financial_agent/anomalies/${projectId}`;
        const params = [];
        
        if (severityFilter !== 'all') {
            params.push(`severity=${severityFilter}`);
        }
        if (statusFilter) {
            params.push(`status=${statusFilter}`);
        }
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            allAnomaliesData = data.anomalies;
            // Don't update summary here - keep the total counts
            displayAnomalies(data.anomalies);
        } else {
            console.error('Error loading anomalies:', data.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function updateAnomalySummary(severityCounts, totalCount) {
    // Update total badge
    document.getElementById('anomaly-total-badge').textContent = totalCount || 0;
    
    // Update pills
    const critical = severityCounts.critical || 0;
    const high = severityCounts.high || 0;
    const medium = severityCounts.medium || 0;
    const low = severityCounts.low || 0;
    
    document.querySelector('#pill-critical .pill-count').textContent = critical;
    document.querySelector('#pill-high .pill-count').textContent = high;
    document.querySelector('#pill-medium .pill-count').textContent = medium;
    document.querySelector('#pill-low .pill-count').textContent = low;
    
    // Add pulse animation to pills with counts
    [
        { id: 'pill-critical', count: critical },
        { id: 'pill-high', count: high },
        { id: 'pill-medium', count: medium },
        { id: 'pill-low', count: low }
    ].forEach(pill => {
        const elem = document.getElementById(pill.id);
        if (pill.count > 0) {
            elem.classList.add('pill-active');
        } else {
            elem.classList.remove('pill-active');
        }
    });
}

function displayAnomalies(anomalies) {
    const container = document.getElementById('anomaly-content');
    
    if (!anomalies || anomalies.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-shield-check"></i>
                <h3>No Anomalies Detected</h3>
                <p>All transactions appear normal. The system is monitoring continuously.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="anomaly-grid">';
    anomalies.forEach(anomaly => {
        const metadata = anomaly.metadata || {};
        const severityLevel = metadata.severity_level || 'low';
        const severity = metadata.severity || 0;
        const amount = metadata.amount || 0;
        const category = metadata.category || 'general';
        const vendor = metadata.vendor_recipient || 'Unknown';
        const date = metadata.date || 'Unknown';
        const status = metadata.status || 'unreviewed';
        
        // Severity styling
        const severityColors = {
            critical: { bg: 'from-red-50 to-red-100', border: 'border-red-600', text: 'text-red-700', badge: 'bg-red-600' },
            high: { bg: 'from-orange-50 to-orange-100', border: 'border-orange-600', text: 'text-orange-700', badge: 'bg-orange-600' },
            medium: { bg: 'from-yellow-50 to-yellow-100', border: 'border-yellow-600', text: 'text-yellow-700', badge: 'bg-yellow-600' },
            low: { bg: 'from-blue-50 to-blue-100', border: 'border-blue-600', text: 'text-blue-700', badge: 'bg-blue-600' }
        };
        
        const colors = severityColors[severityLevel];
        const statusIcon = status === 'reviewed' ? 'fa-check-circle' : 
                          status === 'dismissed' ? 'fa-times-circle' : 
                          'fa-exclamation-triangle';
        const statusColor = status === 'reviewed' ? 'status-reviewed' : 
                           status === 'dismissed' ? 'status-dismissed' : 
                           'status-unreviewed';
        
        html += `
            <div class="anomaly-card severity-${severityLevel} ${statusColor}">
                <div class="anomaly-card-header">
                    <div class="anomaly-card-title">
                        <span class="severity-badge badge-${severityLevel}">${severityLevel.toUpperCase()}</span>
                        <span class="anomaly-score">Score: ${severity}/100</span>
                    </div>
                    <div class="anomaly-status">
                        <i class="fas ${statusIcon}"></i>
                        <span>${status}</span>
                    </div>
                </div>
                
                <div class="anomaly-card-body">
                    <div class="anomaly-amount">
                        <i class="fas fa-dollar-sign"></i>
                        <span class="amount-value">PKR ${formatNumber(amount)}</span>
                    </div>
                    
                    <div class="anomaly-details-grid">
                        <div class="detail-item">
                            <i class="fas fa-tag"></i>
                            <div>
                                <div class="detail-label">Category</div>
                                <div class="detail-value">${category}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user-tie"></i>
                            <div>
                                <div class="detail-label">Vendor</div>
                                <div class="detail-value">${vendor || 'Unknown'}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <div>
                                <div class="detail-label">Date</div>
                                <div class="detail-value">${date}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="anomaly-explanation">
                        <i class="fas fa-lightbulb"></i>
                        <p>This transaction deviates significantly from normal spending patterns based on amount analysis, category averages, and vendor history.</p>
                    </div>
                    
                    ${status === 'unreviewed' ? `
                        <div class="anomaly-actions">
                            <button onclick="markAnomalyReviewed('${anomaly.id}')" class="action-btn-primary">
                                <i class="fas fa-check"></i> Mark as Reviewed
                            </button>
                            <button onclick="dismissAnomaly('${anomaly.id}')" class="action-btn-secondary">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function markAnomalyReviewed(anomalyId) {
    try {
        const response = await fetch('/financial_agent/anomalies/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                anomaly_id: anomalyId,
                status: 'reviewed',
                notes: 'Marked as reviewed by user'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Anomaly marked as reviewed', 'success');
            loadAnomalies(currentAnomalyView);
        } else {
            showNotification('Failed to update anomaly', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error updating anomaly', 'error');
    }
}

async function dismissAnomaly(anomalyId) {
    try {
        const response = await fetch('/financial_agent/anomalies/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                anomaly_id: anomalyId,
                status: 'dismissed',
                notes: 'Dismissed as false positive'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Anomaly dismissed', 'success');
            loadAnomalies(currentAnomalyView);
        } else {
            showNotification('Failed to dismiss anomaly', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error dismissing anomaly', 'error');
    }
}

function exportAnomalies() {
    if (!allAnomaliesData || allAnomaliesData.length === 0) {
        showNotification('No anomalies to export', 'error');
        return;
    }
    
    const exportData = allAnomaliesData.map(a => ({
        severity: a.metadata.severity_level,
        score: a.metadata.severity,
        amount: a.metadata.amount,
        category: a.metadata.category,
        vendor: a.metadata.vendor_recipient,
        date: a.metadata.date,
        status: a.metadata.status,
        detected_at: a.metadata.detected_at
    }));
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `anomalies_${projectId}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('Anomalies exported successfully', 'success');
}

</script>

<style>
.financial-dashboard {
    padding: 2rem;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
}

.dashboard-title-modern {
    font-size: 2.75rem;
    font-weight: 800;
    color: #2d3748;
    margin: 0 0 12px 0;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.dashboard-subtitle-modern {
    font-size: 1.25rem;
    font-weight: 600;
    color: rgba(45, 55, 72, 0.8);
    margin: 0 0 16px 0;
    line-height: 1.5;
}

.dashboard-meta-info {
    display: flex;
    align-items: center;
    gap: 24px;
    font-size: 0.9rem;
    color: rgba(45, 55, 72, 0.6);
    font-weight: 500;
    flex-wrap: wrap;
}

.dashboard-controls {
    display: flex;
    gap: 1rem;
}

/* ===== FINANCIAL METRICS GRID LAYOUT ===== */
.financial-metrics-grid {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 2rem;
    margin-top: 2rem;
}

.metrics-column {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

@media (max-width: 1200px) {
    .financial-metrics-grid {
        grid-template-columns: 1fr;
    }
}

/* ===== METRIC CARDS STYLING v2.1 - Pure White BG ===== */
.metrics-overview {
    margin-top: 2rem;
}

.metric-card {
    background: #ffffff !important;
    backdrop-filter: none !important;
    border-radius: 20px;
    padding: 2rem;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    border: 3px solid;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-10px) scale(1.03);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
}

.metric-card:hover::before {
    opacity: 0.04;
}

/* Card Color Variants */
.metric-card-blue {
    --card-color-1: #3b82f6;
    --card-color-2: #1d4ed8;
    border-color: #3b82f6 !important;
    background: #ffffff !important;
}

.metric-card-blue::before {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.metric-card-blue:hover {
    box-shadow: 0 20px 60px rgba(59, 130, 246, 0.35) !important;
    border-color: #2563eb !important;
}

.metric-card-amber {
    --card-color-1: #f59e0b;
    --card-color-2: #d97706;
    border-color: #f59e0b !important;
    background: #ffffff !important;
}

.metric-card-amber::before {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.metric-card-amber:hover {
    box-shadow: 0 20px 60px rgba(245, 158, 11, 0.35) !important;
    border-color: #f59e0b !important;
}

.metric-card-green {
    --card-color-1: #10b981;
    --card-color-2: #059669;
    border-color: #10b981 !important;
    background: #ffffff !important;
}

.metric-card-green::before {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.metric-card-green:hover {
    box-shadow: 0 20px 60px rgba(16, 185, 129, 0.35) !important;
    border-color: #059669 !important;
}

.metric-card-purple {
    --card-color-1: #8b5cf6;
    --card-color-2: #7c3aed;
    border-color: #8b5cf6 !important;
    background: #ffffff !important;
}

.metric-card-purple::before {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.metric-card-purple:hover {
    box-shadow: 0 20px 60px rgba(139, 92, 246, 0.35) !important;
    border-color: #7c3aed !important;
}

/* Card Header */
.metric-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.metric-icon-wrapper {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.metric-card:hover .metric-icon-wrapper {
    transform: rotate(5deg) scale(1.1);
}

.metric-icon-blue {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.metric-icon-amber {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.metric-icon-green {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.metric-icon-purple {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.metric-badge {
    padding: 0.5rem 1rem;
    border-radius: 14px;
    font-size: 0.8rem;
    font-weight: 700;
    background: rgba(0, 0, 0, 0.05);
    color: #374151;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.metric-badge-blue {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.metric-badge-amber {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.metric-badge-green {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.metric-card:hover .metric-badge {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Card Body */
.metric-card-body {
    display: flex;
    flex-direction: column;
}

.metric-card-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 0.75rem;
}

.metric-value {
    font-size: 2.25rem;
    font-weight: 900;
    margin-bottom: 0.25rem;
    letter-spacing: -0.5px;
    transition: all 0.3s ease;
}

.metric-card:hover .metric-value {
    transform: scale(1.05);
    transform-origin: left center;
}

.metric-subtitle {
    font-size: 0.875rem;
    color: #4b5563;
    margin-bottom: 1rem;
    font-weight: 500;
}

/* Progress Container */
.metric-progress-container {
    margin-top: 1.25rem;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 14px;
}

.metric-progress-bar {
    width: 100%;
    height: 10px;
    background: rgba(0, 0, 0, 0.06);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
}

.metric-progress-fill {
    height: 100%;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.metric-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.metric-progress-blue {
    background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
}

.metric-progress-text {
    font-size: 0.75rem;
    color: #1f2937;
    margin-top: 0.65rem;
    font-weight: 600;
}

/* Info Row */
.metric-info-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1.25rem;
    padding: 0.85rem 1.15rem;
    background: rgba(0, 0, 0, 0.03);
    border-radius: 14px;
    font-size: 0.875rem;
    color: #1f2937;
    font-weight: 600;
    border: 1px solid rgba(0, 0, 0, 0.08);
}

.metric-info-row i {
    color: #4b5563;
    font-size: 1rem;
}

/* Health Circle */
.health-circle-container {
    display: flex;
    justify-content: center;
    margin: 1rem 0;
}

.health-circle {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
    position: relative;
    transition: all 0.4s ease;
}

.metric-card:hover .health-circle {
    transform: scale(1.12) rotate(5deg);
    box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
}

.health-circle::before {
    content: '';
    position: absolute;
    inset: 10px;
    border-radius: 50%;
    background: white;
}

.health-percentage {
    font-size: 2rem;
    font-weight: 900;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    z-index: 1;
    text-shadow: 0 2px 4px rgba(139, 92, 246, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .metric-card {
        padding: 1.5rem;
    }
    
    .metric-value {
        font-size: 1.75rem;
    }
    
    .health-circle {
        width: 110px;
        height: 110px;
    }
    
    .health-percentage {
        font-size: 1.65rem;
    }
}

/* ===== VISUALIZATION CARD ===== */
.visualization-card {
    background: #ffffff !important;
    backdrop-filter: none !important;
    border-radius: 20px;
    padding: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    border: 3px solid #6366f1;
    display: flex;
    flex-direction: column;
}

.visualization-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 60px rgba(99, 102, 241, 0.3) !important;
}

.viz-card-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}

.viz-header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.viz-icon-wrapper {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.viz-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
}

.viz-subtitle {
    font-size: 0.875rem;
    opacity: 0.9;
    margin: 0;
}

.viz-tabs {
    display: flex;
    gap: 0.5rem;
}

.viz-tab {
    padding: 0.5rem 1rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.viz-tab:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
}

.viz-tab.active {
    background: white;
    color: #6366f1;
    border-color: white;
}

.viz-card-body {
    padding: 2rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.chart-container {
    position: relative;
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-legend {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.chart-legend::-webkit-scrollbar {
    width: 6px;
}

.chart-legend::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
}

.chart-legend::-webkit-scrollbar-thumb {
    background: #6366f1;
    border-radius: 3px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.65rem 0.85rem;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 10px;
    transition: all 0.3s ease;
    min-width: 0;
}

.legend-item:hover {
    background: rgba(0, 0, 0, 0.04);
    transform: translateX(4px);
}

.legend-color {
    width: 14px;
    height: 14px;
    border-radius: 4px;
    flex-shrink: 0;
}

.legend-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
}

.legend-label {
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.legend-amounts {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
}

.legend-value {
    font-weight: 700;
    color: #6366f1;
    font-size: 0.8rem;
}

.legend-percent {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 600;
}

/* Exchange Rate Display */
.exchange-rate-display {
    margin-top: 1.5rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 12px;
    border: 2px solid #3b82f6;
}

.exchange-rate-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.exchange-icon {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.exchange-info {
    flex: 1;
}

.exchange-label {
    font-size: 0.75rem;
    color: #1e40af;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.exchange-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1e3a8a;
}

.exchange-badge {
    padding: 0.5rem 0.75rem;
    background: rgba(59, 130, 246, 0.15);
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #1d4ed8;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    white-space: nowrap;
}

.exchange-badge i {
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Anomaly Alert Display */
.anomaly-alert-display {
    margin-top: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 12px;
    border: 2px solid #f59e0b;
}

.anomaly-alert-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.anomaly-alert-icon {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.anomaly-alert-info {
    flex: 1;
}

.anomaly-alert-label {
    font-size: 0.75rem;
    color: #92400e;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.anomaly-alert-summary {
    font-size: 1.25rem;
    font-weight: 800;
    color: #78350f;
}

.anomaly-breakdown {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.6rem;
}

.anomaly-severity-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem 0.6rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    border: none;
}

.anomaly-severity-badge:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

.anomaly-severity-count {
    font-size: 1.75rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.35rem;
    color: white;
}

.anomaly-severity-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(255, 255, 255, 0.95);
}

/* Subtle variations for different severities */
.badge-critical {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

.badge-critical:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
}

.badge-high {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.badge-high:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

.badge-medium {
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
}

.badge-medium:hover {
    background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
    box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
}

.badge-low {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
}

.badge-low:hover {
    background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
}

/* CSV Analysis CTA */
.csv-analysis-cta {
    margin-top: 1rem;
}

.csv-cta-button {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 12px;
    border: 2px solid #1d4ed8;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    cursor: pointer;
}

.csv-cta-button:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
}

.csv-cta-icon {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.csv-cta-button:hover .csv-cta-icon {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(-5deg) scale(1.1);
}

.csv-cta-content {
    flex: 1;
}

.csv-cta-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.25rem;
    letter-spacing: 0.3px;
}

.csv-cta-subtitle {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    line-height: 1.4;
}

.csv-cta-arrow {
    width: 35px;
    height: 35px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.csv-cta-button:hover .csv-cta-arrow {
    background: rgba(255, 255, 255, 0.3);
    transform: translateX(4px);
}

.viz-card-footer {
    display: flex;
    justify-content: space-around;
    padding: 1.5rem 2rem;
    background: rgba(0, 0, 0, 0.02);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.viz-stat {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.viz-stat i {
    font-size: 1.5rem;
}

.viz-stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.viz-stat-value {
    font-size: 1.1rem;
    font-weight: 800;
    color: #1f2937;
}

.loading-dots {
    font-size: 1.5rem;
    color: #9ca3af;
    animation: blink 1.4s infinite;
}

@keyframes blink {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
}

@media (max-width: 1024px) {
    .viz-card-footer {
        flex-wrap: wrap;
    }
}

@media (max-width: 768px) {
    .viz-card-footer {
        flex-direction: column;
        gap: 1rem;
    }
    
    .chart-container {
        height: 220px;
    }
    
    .viz-tabs {
        flex-direction: column;
        width: 100%;
    }
    
    .viz-tab {
        width: 100%;
        justify-content: center;
    }
    
    .viz-stat-value {
        font-size: 1rem;
    }
    
    .viz-stat i {
        font-size: 1.25rem;
    }
    
    .exchange-rate-content {
        flex-direction: column;
        text-align: center;
    }
    
    .exchange-value {
        font-size: 1.25rem;
    }
    
    .anomaly-alert-header {
        flex-wrap: wrap;
    }
    
    .anomaly-breakdown {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .anomaly-alert-summary {
        font-size: 1.1rem;
    }
    
    .csv-cta-button {
        flex-direction: column;
        text-align: center;
        padding: 1.5rem;
    }
    
    .csv-cta-icon {
        width: 55px;
        height: 55px;
        font-size: 1.75rem;
    }
    
    .csv-cta-title {
        font-size: 1rem;
    }
    
    .csv-cta-subtitle {
        font-size: 0.8rem;
    }
    
    .csv-cta-arrow {
        display: none;
    }
}

.transaction-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.transaction-icon.expense {
    background: #fef3c7;
    color: #d97706;
}

.transaction-icon.revenue {
    background: #d1fae5;
    color: #059669;
}

.section {
    margin-top: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: bold;
}

.filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.badge-success {
    background: #d1fae5;
    color: #059669;
}

.badge-warning {
    background: #fef3c7;
    color: #d97706;
}

.badge-danger {
    background: #fee2e2;
    color: #dc2626;
}

.badge-info {
    background: #dbeafe;
    color: #2563eb;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-outline {
    background: white;
    color: #374151;
    border: 1px solid #d1d5db;
}

/* ==================== ANOMALY DETECTION MEGA CARD ==================== */

.anomaly-mega-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    overflow: hidden;
    transition: all 0.3s ease;
}

.anomaly-mega-card:hover {
    box-shadow: 0 15px 50px rgba(102, 126, 234, 0.4);
    transform: translateY(-2px);
}

.anomaly-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem;
    cursor: pointer;
    user-select: none;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

.anomaly-header-left {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.anomaly-icon-wrapper {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: white;
}

.anomaly-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.anomaly-badge {
    background: rgba(239, 68, 68, 0.9);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
    min-width: 30px;
    text-align: center;
}

.anomaly-subtitle {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.875rem;
    margin: 0.25rem 0 0 0;
}

.anomaly-header-right {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.anomaly-summary-pills {
    display: flex;
    gap: 0.75rem;
}

.pill {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 0.5rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 70px;
    transition: all 0.3s ease;
    cursor: pointer;
    user-select: none;
}

.pill:hover {
    background: rgba(255, 255, 255, 0.35);
    transform: scale(1.08);
}

.pill-active {
    background: rgba(255, 255, 255, 0.3) !important;
    animation: pulse 2s infinite;
}

.pill-count {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
}

.pill-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
    margin-top: 0.125rem;
}

.expand-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.expand-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(180deg);
}

.anomaly-body {
    background: white;
    padding: 2rem;
    animation: slideDown 0.3s ease-out;
}

.anomaly-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
}

.control-tabs {
    display: flex;
    gap: 0.5rem;
}

.tab-btn {
    background: #f3f4f6;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn:hover {
    background: #e5e7eb;
    color: #374151;
}

.tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.control-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    background: #f3f4f6;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.action-btn:hover {
    background: #667eea;
    color: white;
}

.anomaly-content {
    min-height: 200px;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
}

.empty-state i {
    font-size: 4rem;
    color: #10b981;
    margin-bottom: 1rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #374151;
    margin: 0 0 0.5rem 0;
}

.empty-state p {
    color: #6b7280;
    font-size: 1rem;
}

.anomaly-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
}

.anomaly-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border-left: 4px solid;
}

.anomaly-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    transform: translateY(-4px);
}

.anomaly-card.severity-critical {
    border-left-color: #dc2626;
}

.anomaly-card.severity-high {
    border-left-color: #f97316;
}

.anomaly-card.severity-medium {
    border-left-color: #eab308;
}

.anomaly-card.severity-low {
    border-left-color: #3b82f6;
}

.anomaly-card-header {
    background: linear-gradient(to right, #f9fafb, #f3f4f6);
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.anomaly-card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.severity-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
}

.badge-critical {
    background: #dc2626;
}

.badge-high {
    background: #f97316;
}

.badge-medium {
    background: #eab308;
}

.badge-low {
    background: #3b82f6;
}

.anomaly-score {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
}

.anomaly-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.status-reviewed .anomaly-status {
    color: #10b981;
}

.status-dismissed .anomaly-status {
    color: #9ca3af;
}

.status-unreviewed .anomaly-status {
    color: #ef4444;
}

.anomaly-card-body {
    padding: 1.5rem;
}

.anomaly-amount {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea15, #764ba215);
    border-radius: 8px;
    margin-bottom: 1.25rem;
}

.anomaly-amount i {
    font-size: 2rem;
    color: #667eea;
}

.amount-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
}

.anomaly-details-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.25rem;
}

.detail-item {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
}

.detail-item i {
    color: #667eea;
    margin-top: 0.25rem;
}

.detail-label {
    font-size: 0.75rem;
    color: #9ca3af;
    text-transform: uppercase;
    font-weight: 600;
}

.detail-value {
    font-size: 0.875rem;
    color: #374151;
    font-weight: 500;
    margin-top: 0.125rem;
}

.anomaly-explanation {
    background: #fef3c7;
    border-left: 3px solid #f59e0b;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1.25rem;
    display: flex;
    gap: 0.75rem;
}

.anomaly-explanation i {
    color: #f59e0b;
    margin-top: 0.125rem;
    font-size: 1.125rem;
}

.anomaly-explanation p {
    margin: 0;
    font-size: 0.875rem;
    color: #92400e;
    line-height: 1.5;
}

.anomaly-actions {
    display: flex;
    gap: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}

.action-btn-primary {
    flex: 1;
    background: #10b981;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.action-btn-primary:hover {
    background: #059669;
    transform: scale(1.02);
}

.action-btn-secondary {
    flex: 1;
    background: #6b7280;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.action-btn-secondary:hover {
    background: #4b5563;
    transform: scale(1.02);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

@media (max-width: 768px) {
    .anomaly-header {
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .anomaly-summary-pills {
        flex-wrap: wrap;
    }
    
    .anomaly-grid {
        grid-template-columns: 1fr;
    }
    
    .anomaly-details-grid {
        grid-template-columns: 1fr;
    }
    
    .control-tabs {
        flex-wrap: wrap;
    }
}

/* ==================== EXPENSE ANALYSIS MEGA CARD ==================== */

.expense-mega-card {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
    overflow: hidden;
    transition: all 0.3s ease;
}

.expense-mega-card:hover {
    box-shadow: 0 15px 50px rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
}

.expense-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2.5rem 3rem;
    cursor: pointer;
    user-select: none;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    min-height: 140px;
}

.expense-header-left {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.expense-icon-wrapper {
    width: 70px;
    height: 70px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.expense-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.expense-badge {
    background: rgba(255, 255, 255, 0.95);
    color: #059669;
    padding: 0.4rem 1rem;
    border-radius: 14px;
    font-size: 0.875rem;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.expense-subtitle {
    color: rgba(255, 255, 255, 0.95);
    font-size: 0.875rem;
    margin: 0;
    letter-spacing: 0.3px;
}

.expense-header-right {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.expense-summary-pills {
    display: flex;
    gap: 1rem;
}

.pill-expense {
    background: rgba(255, 255, 255, 0.15);
    padding: 0.75rem 1.25rem;
    min-width: 85px;
}

.pill-expense:hover {
    background: rgba(255, 255, 255, 0.35);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.expense-body {
    background: white;
    padding: 2rem;
    animation: slideDown 0.3s ease-out;
}

.expense-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
}

.expense-content {
    min-height: 200px;
}

.expense-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.expense-card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.expense-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    transform: translateY(-4px);
}

.expense-card-header {
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.expense-card-title {
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.expense-percentage {
    font-size: 1.25rem;
    font-weight: 700;
    color: #6b7280;
}

.expense-card-body {
    padding: 1.5rem;
}

.expense-amount-display {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-bottom: 1rem;
}

.amount-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
}

.amount-value {
    font-size: 1.75rem;
    font-weight: 700;
}

.expense-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.expense-progress-fill {
    height: 100%;
    transition: width 0.5s ease;
}

/* Vendor View Styles */
.expense-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.vendor-item {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: all 0.3s ease;
}

.vendor-item:hover {
    border-color: #10b981;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    transform: translateX(4px);
}

.vendor-rank {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.vendor-info {
    flex: 1;
}

.vendor-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.vendor-progress-bar {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}

.vendor-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    transition: width 0.5s ease;
}

.vendor-stats {
    text-align: right;
}

.vendor-amount {
    font-size: 1.25rem;
    font-weight: 700;
    color: #10b981;
}

.vendor-percentage {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

/* Task Mapping View */
.task-expense-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.task-expense-card {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 2px solid #3b82f6;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.task-expense-card:hover {
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2);
    transform: translateY(-4px);
}

.task-expense-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.task-name {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.875rem;
}

.task-expense-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: #3b82f6;
}

/* Breakdown View */
.breakdown-view {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.breakdown-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.breakdown-card {
    background: linear-gradient(135deg, #f9fafb, #f3f4f6);
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.breakdown-card i {
    font-size: 2rem;
}

.breakdown-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
}

.breakdown-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-top: 0.25rem;
}

.breakdown-details {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 2rem;
}

.breakdown-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
}

.breakdown-section {
    margin-bottom: 2rem;
}

.breakdown-section h4 {
    font-size: 1rem;
    font-weight: 600;
    color: #10b981;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.breakdown-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.breakdown-list li {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
}

.breakdown-list li:last-child {
    border-bottom: none;
}

.breakdown-list li:hover {
    background: #f9fafb;
}

@media (max-width: 768px) {
    .expense-header {
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .expense-summary-pills {
        flex-wrap: wrap;
    }
    
    .expense-grid {
        grid-template-columns: 1fr;
    }
    
    .task-expense-grid {
        grid-template-columns: 1fr;
    }
}

</style>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let financialChart = null;
let currentChartType = 'expenses';
let currentFinancialData = {};

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeFinancialChart();
});

function initializeFinancialChart() {
    const ctx = document.getElementById('financialChart');
    if (!ctx) return;
    
    financialChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [],
                borderWidth: 3,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = 'PKR ' + formatNumber(context.parsed);
                            const percent = ((context.parsed / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                            return `${label}: ${value} (${percent}%)`;
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1
                }
            },
            cutout: '65%'
        }
    });
}

function switchChart(type) {
    currentChartType = type;
    
    // Update tab active state
    document.querySelectorAll('.viz-tab').forEach(tab => {
        if (tab.dataset.chart === type) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Update chart data
    updateFinancialChart();
}

function updateFinancialChart() {
    if (!financialChart || !currentFinancialData) return;
    
    let data = {};
    let colors = [];
    let transactionCount = 0;
    
    if (currentChartType === 'expenses') {
        data = currentFinancialData.expense_by_category || {};
        transactionCount = currentFinancialData.expense_count || 0;
        colors = [
            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
        ];
    } else if (currentChartType === 'revenue') {
        data = currentFinancialData.revenue_by_source || {};
        transactionCount = currentFinancialData.revenue_count || 0;
        colors = [
            '#10b981', '#059669', '#34d399', '#6ee7b7',
            '#a7f3d0', '#d1fae5', '#6366f1', '#8b5cf6'
        ];
    }
    
    const labels = Object.keys(data);
    const values = Object.values(data);
    const totalAmount = values.reduce((a, b) => a + b, 0);
    
    // Update chart
    financialChart.data.labels = labels;
    financialChart.data.datasets[0].data = values;
    financialChart.data.datasets[0].backgroundColor = colors.slice(0, labels.length);
    financialChart.update();
    
    // Update legend
    updateChartLegend(labels, values, colors.slice(0, labels.length), totalAmount);
    
    // Update stats
    document.getElementById('viz-categories').textContent = labels.length;
    document.getElementById('viz-total').textContent = `PKR ${formatNumber(totalAmount)}`;
    document.getElementById('viz-transactions').textContent = transactionCount;
}

function updateChartLegend(labels, values, colors, totalAmount) {
    const legendContainer = document.getElementById('chartLegend');
    if (!legendContainer) return;
    
    if (labels.length === 0) {
        legendContainer.innerHTML = '<p class="text-gray-500 text-center">No data available</p>';
        return;
    }
    
    legendContainer.innerHTML = labels.map((label, index) => {
        const value = values[index];
        const percent = ((value / totalAmount) * 100).toFixed(1);
        
        return `
            <div class="legend-item" title="${label}">
                <div class="legend-color" style="background: ${colors[index]}"></div>
                <div class="legend-text">
                    <span class="legend-label">${label}</span>
                    <div class="legend-amounts">
                        <span class="legend-value">PKR ${formatNumber(value)}</span>
                        <span class="legend-percent">${percent}%</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function loadChartData() {
    try {
        // Load expense analysis
        const expenseResponse = await fetch(`/financial_agent/expenses/${projectId}`);
        const expenseData = await expenseResponse.json();
        
        if (expenseData.success && expenseData.expense_analysis) {
            currentFinancialData.expense_by_category = expenseData.expense_analysis.by_category || {};
            currentFinancialData.expense_count = expenseData.expense_analysis.count || 0;
        }
        
        // Load revenue analysis
        const revenueResponse = await fetch(`/financial_agent/revenue/${projectId}`);
        const revenueData = await revenueResponse.json();
        
        if (revenueData.success && revenueData.revenue_analysis) {
            currentFinancialData.revenue_by_source = revenueData.revenue_analysis.by_source || {};
            currentFinancialData.revenue_count = revenueData.revenue_analysis.count || 0;
        }
        
        updateFinancialChart();
        
        // Load exchange rate
        await loadExchangeRate();
        
        // Load anomaly summary
        await loadAnomalySummary();
        
    } catch (error) {
        console.error('Error loading chart data:', error);
    }
}

async function loadExchangeRate() {
    const rateElement = document.getElementById('viz-exchange-rate-main');
    
    try {
        /* FREE CURRENCY EXCHANGE RATE APIs (No API Key Required):
         * 
         * 1. ExchangeRate-API (CURRENTLY USED) - Best for PKR
         *    URL: https://api.exchangerate-api.com/v4/latest/PKR
         *    - Free, no API key required
         *    - Supports PKR
         *    - Updated regularly
         * 
         * 2. Currency API (Alternative)
         *    URL: https://cdn.jsdelivr.net/gh/fawazahmed0/currency-api@1/latest/currencies/pkr.json
         *    - Free, no limits
         *    - Updated daily
         * 
         * 3. Frankfurter API (Doesn't support PKR)
         *    URL: https://api.frankfurter.app/latest
         *    - Note: PKR not available
         */
        
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/PKR');
        const data = await response.json();
        
        if (data && data.rates && data.rates.USD) {
            const rate = data.rates.USD.toFixed(4);
            const date = new Date(data.time_last_updated * 1000 || Date.now());
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            rateElement.innerHTML = `
                <span style="font-size: 1.25rem;">PKR 1</span> 
                <span style="font-size: 1.1rem; margin: 0 0.5rem;">‚Üí</span> 
                <span style="font-size: 1.5rem; color: #16a34a;">$${rate}</span>
                <span style="font-size: 0.75rem; color: #6b7280; margin-left: 0.5rem;">(${dateStr})</span>
            `;
        } else {
            rateElement.innerHTML = '<span style="font-size: 1rem; color: #9ca3af;">Rate unavailable</span>';
        }
    } catch (error) {
        console.error('Error loading exchange rate:', error);
        rateElement.innerHTML = '<span style="font-size: 1rem; color: #ef4444;">Unable to fetch rate</span>';
    }
}

// Load anomaly summary for visualization card
async function loadAnomalySummary() {
    try {
        const response = await fetch(`/financial_agent/anomalies/${projectId}`);
        const data = await response.json();
        
        if (data.success) {
            updateVizAnomalySummary(data.total_count, data.severity_counts);
        }
    } catch (error) {
        console.error('Error loading anomaly summary:', error);
        const summaryElement = document.getElementById('viz-anomaly-summary');
        if (summaryElement) {
            summaryElement.innerHTML = '<span style="font-size: 1rem; color: #ef4444;">Error loading data</span>';
        }
    }
}

// Update visualization card anomaly summary
function updateVizAnomalySummary(total, counts) {
    const summaryElement = document.getElementById('viz-anomaly-summary');
    const breakdownElement = document.getElementById('viz-anomaly-breakdown');
    
    if (!summaryElement || !breakdownElement) return;
    
    total = total || 0;
    counts = counts || { critical: 0, high: 0, medium: 0, low: 0 };
    
    // Update summary text
    if (total === 0) {
        summaryElement.innerHTML = '<span style="color: #16a34a;">‚úì No anomalies detected</span>';
    } else {
        summaryElement.innerHTML = `<span style="color: #dc2626;">${total} ${total === 1 ? 'Anomaly' : 'Anomalies'} Detected</span>`;
    }
    
    // Update breakdown badges
    breakdownElement.innerHTML = `
        <div class="anomaly-severity-badge badge-critical" onclick="openAndSwitchView('critical')" title="View Critical Anomalies">
            <div class="anomaly-severity-count">${counts.critical}</div>
            <div class="anomaly-severity-label">Critical</div>
        </div>
        <div class="anomaly-severity-badge badge-high" onclick="openAndSwitchView('high')" title="View High Risk">
            <div class="anomaly-severity-count">${counts.high}</div>
            <div class="anomaly-severity-label">High</div>
        </div>
        <div class="anomaly-severity-badge badge-medium" onclick="openAndSwitchView('medium')" title="View Medium Risk">
            <div class="anomaly-severity-count">${counts.medium}</div>
            <div class="anomaly-severity-label">Medium</div>
        </div>
        <div class="anomaly-severity-badge badge-low" onclick="openAndSwitchView('low')" title="View Low Risk">
            <div class="anomaly-severity-count">${counts.low}</div>
            <div class="anomaly-severity-label">Low</div>
        </div>
    `;
}

// Load chart data after refresh completes
async function onRefreshComplete() {
    await loadChartData();
    await loadAnomalies('all');
}
</script>

{% endblock %}

